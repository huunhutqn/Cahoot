import { createRequire } from 'module';const require = createRequire(import.meta.url);
import W from"zod";var oe=W.string().min(4,"Username cannot be less than 4 characters").max(20,"Username cannot exceed 20 characters"),F=W.string().length(6,"Invalid invite code");import{z as u}from"zod/v4";var X=u.object({question:u.string().min(1,"Question is required"),answers:u.array(u.string()).min(2,"At least 2 answers required").max(4,"Maximum 4 answers allowed"),image:u.string().url().optional(),solution:u.number().int().min(0,"Solution index must be 0 or greater"),cooldown:u.number().int().min(0,"Cooldown must be 0 or greater"),time:u.number().int().min(1,"Time must be at least 1 second")}),_=u.object({subject:u.string().min(1,"Subject is required"),questions:u.array(X).min(1,"At least 1 question required")}),f=u.string().regex(/^[a-zA-Z0-9_-]+$/,{message:"Quiz ID can only contain letters, numbers, hyphens and underscores"}),T=u.object({id:f,data:_}),P=u.object({id:f,data:_}),R=u.object({id:f});import w from"fs";import g from"fs/promises";import{resolve as D}from"path";var L=process.env.CONFIG_PATH,h=(s="")=>L?D(L,s):D(process.cwd(),"config",s),O=class{static cache=new Map;static cacheTimestamp=0;static CACHE_TTL=6e4;static async getAll(){let e=Date.now();if(this.cache.size>0&&e-this.cacheTimestamp<this.CACHE_TTL)return Array.from(this.cache.values());let t=h("quizz");if(!w.existsSync(t))return[];try{let a=(await g.readdir(t)).filter(n=>n.endsWith(".json")),i=await Promise.all(a.map(async n=>{let m=await g.readFile(h(`quizz/${n}`),"utf-8"),q=JSON.parse(m);return{id:n.replace(".json",""),...q}}));return this.cache.clear(),i.forEach(n=>this.cache.set(n.id,n)),this.cacheTimestamp=e,i}catch(r){return console.error("Failed to read quizz config:",r),[]}}static getAllSync(){let e=h("quizz");if(!w.existsSync(e))return[];try{return w.readdirSync(e).filter(a=>a.endsWith(".json")).map(a=>{let i=w.readFileSync(h(`quizz/${a}`),"utf-8"),n=JSON.parse(i);return{id:a.replace(".json",""),...n}})||[]}catch(t){return console.error("Failed to read quizz config:",t),[]}}static async getById(e){if(this.cache.has(e)){let r=this.cache.get(e);if(r&&Date.now()-this.cacheTimestamp<this.CACHE_TTL)return r}let t=h(`quizz/${e}.json`);try{let r=await g.readFile(t,"utf-8"),a=JSON.parse(r),i={id:e,...a};return this.cache.set(e,i),i}catch(r){return r.code!=="ENOENT"&&console.error(`Failed to read quizz ${e}:`,r),null}}static getByIdSync(e){let t=h(`quizz/${e}.json`);if(!w.existsSync(t))return null;try{let r=w.readFileSync(t,"utf-8"),a=JSON.parse(r);return{id:e,...a}}catch(r){return console.error(`Failed to read quizz ${e}:`,r),null}}static async create(e,t){let r=h(`quizz/${e}.json`);try{return await g.access(r),{success:!1,error:"Quiz already exists"}}catch{}let a=h("quizz");try{await g.mkdir(a,{recursive:!0})}catch{}try{return await g.writeFile(r,JSON.stringify(t,null,2),"utf-8"),this.invalidateCache(),{success:!0}}catch(i){return console.error(`Failed to create quizz ${e}:`,i),{success:!1,error:"Failed to write file"}}}static async update(e,t){let r=h(`quizz/${e}.json`);try{await g.access(r)}catch{return{success:!1,error:"Quiz not found"}}try{return await g.writeFile(r,JSON.stringify(t,null,2),"utf-8"),this.invalidateCache(),{success:!0}}catch(a){return console.error(`Failed to update quizz ${e}:`,a),{success:!1,error:"Failed to write file"}}}static async delete(e){let t=h(`quizz/${e}.json`);try{await g.access(t)}catch{return{success:!1,error:"Quiz not found"}}try{return await g.unlink(t),this.invalidateCache(),{success:!0}}catch(r){return console.error(`Failed to delete quizz ${e}:`,r),{success:!1,error:"Failed to delete file"}}}static invalidateCache(){this.cache.clear(),this.cacheTimestamp=0}static getCacheStats(){return{size:this.cache.size,age:Date.now()-this.cacheTimestamp,ttl:this.CACHE_TTL}}},o=O;import{Router as k}from"express";var E=k();E.get("/",async(s,e)=>{try{let t=await o.getAll();e.json(t)}catch(t){console.error("Failed to get quizzes:",t),e.status(500).json({error:"Failed to fetch quizzes"})}});E.get("/:id",async(s,e)=>{let t=f.safeParse(s.params.id);if(t.error)return e.status(400).json({error:t.error.issues[0].message});let r=t.data;try{let a=await o.getById(r);if(!a)return e.status(404).json({error:"Quiz not found"});e.json(a)}catch(a){console.error(`Failed to get quiz ${r}:`,a),e.status(500).json({error:"Failed to fetch quiz"})}});E.post("/",async(s,e)=>{let t=T.safeParse(s.body);if(t.error)return e.status(400).json({error:t.error.issues[0].message});try{let{id:r,data:a}=t.data,i=await o.create(r,a);if(!i.success)return e.status(400).json({error:i.error||"Failed to create quiz"});let n=await o.getById(r);if(!n)return e.status(500).json({error:"Failed to retrieve created quiz"});e.status(201).json(n)}catch(r){console.error("Failed to create quiz:",r),e.status(500).json({error:"Failed to create quiz"})}});E.put("/:id",async(s,e)=>{let t=f.safeParse(s.params.id);if(t.error)return e.status(400).json({error:t.error.issues[0].message});let r=P.safeParse({id:s.params.id,data:s.body});if(r.error)return e.status(400).json({error:r.error.issues[0].message});try{let{id:a,data:i}=r.data,n=await o.update(a,i);if(!n.success)return e.status(400).json({error:n.error||"Failed to update quiz"});let m=await o.getById(a);if(!m)return e.status(404).json({error:"Quiz not found"});e.json(m)}catch(a){console.error("Failed to update quiz:",a),e.status(500).json({error:"Failed to update quiz"})}});E.delete("/:id",async(s,e)=>{let t=R.safeParse({id:s.params.id});if(t.error)return e.status(400).json({error:t.error.issues[0].message});try{let{id:r}=t.data,a=await o.delete(r);if(!a.success)return e.status(400).json({error:a.error||"Failed to delete quiz"});e.json({message:"Quiz deleted successfully",id:r})}catch(r){console.error("Failed to delete quiz:",r),e.status(500).json({error:"Failed to delete quiz"})}});var H=E;import{createEnv as ee}from"@t3-oss/env-core";import{z as A}from"zod/v4";var te=ee({server:{NODE_ENV:A.enum(["development","production"]).optional().default("development"),WEB_ORIGIN:A.string().optional().default("http://localhost:3000"),PORT:A.string().optional().default("3001")},runtimeEnv:{NODE_ENV:"production",WEB_ORIGIN:process.env.WEB_ORIGIN,PORT:process.env.PORT}}),v=te;import d from"fs";import{resolve as $}from"path";var B=process.env.CONFIG_PATH,l=(s="")=>B?$(B,s):$(process.cwd(),"config",s),x=class{static init(){d.existsSync(l())||d.mkdirSync(l()),d.existsSync(l("game.json"))||d.writeFileSync(l("game.json"),JSON.stringify({managerPassword:"PASSWORD",music:!0},null,2)),d.existsSync(l("quizz"))||(d.mkdirSync(l("quizz")),d.writeFileSync(l("quizz/example.json"),JSON.stringify({subject:"Example Quizz",questions:[{question:"What is good answer ?",answers:["No","Good answer","No","No"],solution:1,cooldown:5,time:15},{question:"What is good answer with image ?",answers:["No","No","No","Good answer"],image:"https://placehold.co/600x400.png",solution:3,cooldown:5,time:20},{question:"What is good answer with two answers ?",answers:["Good answer","No"],image:"https://placehold.co/600x400.png",solution:0,cooldown:5,time:20}]},null,2)))}static game(){if(!d.existsSync(l("game.json")))throw new Error("Game config not found");try{let t=d.readFileSync(l("game.json"),"utf-8");return JSON.parse(t)}catch(t){console.error("Failed to read game config:",t)}return{}}static quizz(){if(!d.existsSync(l("quizz")))return[];try{return d.readdirSync(l("quizz")).filter(a=>a.endsWith(".json")).map(a=>{let i=d.readFileSync(l(`quizz/${a}`),"utf-8"),n=JSON.parse(i);return{id:a.replace(".json",""),...n}})||[]}catch(t){return console.error("Failed to read quizz config:",t),[]}}},b=x;var c={SHOW_ROOM:"SHOW_ROOM",SHOW_START:"SHOW_START",SHOW_PREPARED:"SHOW_PREPARED",SHOW_QUESTION:"SHOW_QUESTION",SELECT_ANSWER:"SELECT_ANSWER",SHOW_RESULT:"SHOW_RESULT",SHOW_RESPONSES:"SHOW_RESPONSES",SHOW_LEADERBOARD:"SHOW_LEADERBOARD",FINISHED:"FINISHED",WAIT:"WAIT"};import C from"dayjs";var N=class s{static instance=null;games=[];emptyGames=[];cleanupInterval=null;EMPTY_GAME_TIMEOUT_MINUTES=5;CLEANUP_INTERVAL_MS=6e4;constructor(){this.startCleanupTask()}static getInstance(){return s.instance||=new s,s.instance}addGame(e){this.games.push(e),console.log(`Game ${e.gameId} added. Total games: ${this.games.length}`)}getGameById(e){return this.games.find(t=>t.gameId===e)}getGameByInviteCode(e){return this.games.find(t=>t.inviteCode===e)}getPlayerGame(e,t){return this.games.find(r=>r.gameId===e&&r.players.some(a=>a.clientId===t))}getManagerGame(e,t){return this.games.find(r=>r.gameId===e&&r.manager.clientId===t)}getGameByManagerSocketId(e){return this.games.find(t=>t.manager.id===e)}getGameByPlayerSocketId(e){return this.games.find(t=>t.players.some(r=>r.id===e))}markGameAsEmpty(e){this.emptyGames.find(r=>r.game.gameId===e.gameId)||(this.emptyGames.push({since:C().unix(),game:e}),console.log(`Game ${e.gameId} marked as empty. Total empty games: ${this.emptyGames.length}`))}reactivateGame(e){let t=this.emptyGames.length;this.emptyGames=this.emptyGames.filter(r=>r.game.gameId!==e),this.emptyGames.length<t&&console.log(`Game ${e} reactivated. Remaining empty games: ${this.emptyGames.length}`)}removeGame(e){let t=this.games.length;this.games=this.games.filter(a=>a.gameId!==e),this.emptyGames=this.emptyGames.filter(a=>a.game.gameId!==e);let r=this.games.length<t;return r&&console.log(`Game ${e} removed. Total games: ${this.games.length}`),r}getAllGames(){return[...this.games]}getGameCount(){return this.games.length}getEmptyGameCount(){return this.emptyGames.length}cleanupEmptyGames(){let e=C(),t=this.emptyGames.filter(i=>e.diff(C.unix(i.since),"minute")<this.EMPTY_GAME_TIMEOUT_MINUTES);if(t.length===this.emptyGames.length)return;let r=this.emptyGames.filter(i=>!t.includes(i)),a=r.map(i=>i.game.gameId);this.games=this.games.filter(i=>!a.includes(i.gameId)),this.emptyGames=t,console.log(`Removed ${r.length} empty game(s). Remaining games: ${this.games.length}`)}startCleanupTask(){this.cleanupInterval=setInterval(()=>{this.cleanupEmptyGames()},this.CLEANUP_INTERVAL_MS),console.log("Game cleanup task started")}stopCleanupTask(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null,console.log("Game cleanup task stopped"))}cleanup(){this.stopCleanupTask(),this.games=[],this.emptyGames=[],console.log("Registry cleaned up")}},z=N;var y=(s,e,t)=>{if(!s){e.emit("game:errorMessage","Game not found");return}let a=z.getInstance().getGameById(s);if(!a){e.emit("game:errorMessage","Game not found");return}t(a)},V=(s=6)=>{let e="",t="0123456789",r=t.length;for(let a=0;a<s;a+=1){let i=Math.floor(Math.random()*r);e+=t.charAt(i)}return e},U=(s,e)=>{let t=1e3,a=(Date.now()-s)/1e3;return t-=1e3/e*a,t=Math.max(0,t),t};var re=s=>new Promise(e=>{setTimeout(e,s*1e3)}),G=re;import{v4 as se}from"uuid";var J=z.getInstance(),j=class{io;gameId;manager;inviteCode;started;lastBroadcastStatus=null;managerStatus=null;playerStatus=new Map;leaderboard;tempOldLeaderboard;quizz;players;round;cooldown;constructor(e,t,r){if(!e)throw new Error("Socket server not initialized");this.io=e,this.gameId=se(),this.manager={id:"",clientId:"",connected:!1},this.inviteCode="",this.started=!1,this.lastBroadcastStatus=null,this.managerStatus=null,this.playerStatus=new Map,this.leaderboard=[],this.tempOldLeaderboard=null,this.players=[],this.round={playersAnswers:[],currentQuestion:0,startTime:0},this.cooldown={active:!1,ms:0};let a=V();this.inviteCode=a,this.manager={id:t.id,clientId:t.handshake.auth.clientId,connected:!0},this.quizz=r,t.join(this.gameId),t.emit("manager:gameCreated",{gameId:this.gameId,inviteCode:a}),console.log(`New game created: ${a} subject: ${this.quizz.subject}`)}broadcastStatus(e,t){let r={name:e,data:t};this.lastBroadcastStatus=r,this.io.to(this.gameId).emit("game:status",r)}sendStatus(e,t,r){let a={name:t,data:r};this.manager.id===e?this.managerStatus=a:this.playerStatus.set(e,a),this.io.to(e).emit("game:status",a)}join(e,t){if(this.players.find(i=>i.clientId===e.handshake.auth.clientId)){e.emit("game:errorMessage","Player already connected");return}e.join(this.gameId);let a={id:e.id,clientId:e.handshake.auth.clientId,connected:!0,username:t,points:0};this.players.push(a),this.io.to(this.manager.id).emit("manager:newPlayer",a),this.io.to(this.gameId).emit("game:totalPlayers",this.players.length),e.emit("game:successJoin",this.gameId)}kickPlayer(e,t){if(this.manager.id!==e.id)return;let r=this.players.find(a=>a.id===t);r&&(this.players=this.players.filter(a=>a.id!==t),this.playerStatus.delete(t),this.io.in(t).socketsLeave(this.gameId),this.io.to(r.id).emit("game:reset","You have been kicked by the manager"),this.io.to(this.manager.id).emit("manager:playerKicked",r.id),this.io.to(this.gameId).emit("game:totalPlayers",this.players.length))}reconnect(e){let{clientId:t}=e.handshake.auth;this.manager.clientId===t?this.reconnectManager(e):this.reconnectPlayer(e)}reconnectManager(e){if(this.manager.connected){e.emit("game:reset","Manager already connected");return}e.join(this.gameId),this.manager.id=e.id,this.manager.connected=!0;let t=this.managerStatus||this.lastBroadcastStatus||{name:c.WAIT,data:{text:"Waiting for players"}};e.emit("manager:successReconnect",{gameId:this.gameId,currentQuestion:{current:this.round.currentQuestion+1,total:this.quizz.questions.length},status:t,players:this.players}),e.emit("game:totalPlayers",this.players.length),J.reactivateGame(this.gameId),console.log(`Manager reconnected to game ${this.inviteCode}`)}reconnectPlayer(e){let{clientId:t}=e.handshake.auth,r=this.players.find(n=>n.clientId===t);if(!r)return;if(r.connected){e.emit("game:reset","Player already connected");return}e.join(this.gameId);let a=r.id;r.id=e.id,r.connected=!0;let i=this.playerStatus.get(a)||this.lastBroadcastStatus||{name:c.WAIT,data:{text:"Waiting for players"}};if(this.playerStatus.has(a)){let n=this.playerStatus.get(a);this.playerStatus.delete(a),this.playerStatus.set(e.id,n)}e.emit("player:successReconnect",{gameId:this.gameId,currentQuestion:{current:this.round.currentQuestion+1,total:this.quizz.questions.length},status:i,player:{username:r.username,points:r.points}}),e.emit("game:totalPlayers",this.players.length),console.log(`Player ${r.username} reconnected to game ${this.inviteCode}`)}startCooldown(e){if(this.cooldown.active)return Promise.resolve();this.cooldown.active=!0;let t=e-1;return new Promise(r=>{let a=setInterval(()=>{if(!this.cooldown.active||t<=0){this.cooldown.active=!1,clearInterval(a),r();return}this.io.to(this.gameId).emit("game:cooldown",t),t-=1},1e3)})}abortCooldown(){this.cooldown.active&&=!1}async start(e){this.manager.id===e.id&&(this.started||(this.started=!0,this.broadcastStatus(c.SHOW_START,{time:3,subject:this.quizz.subject}),await G(3),this.io.to(this.gameId).emit("game:startCooldown"),await this.startCooldown(3),this.newRound()))}async newRound(){let e=this.quizz.questions[this.round.currentQuestion];this.started&&(this.playerStatus.clear(),this.io.to(this.gameId).emit("game:updateQuestion",{current:this.round.currentQuestion+1,total:this.quizz.questions.length}),this.managerStatus=null,this.broadcastStatus(c.SHOW_PREPARED,{totalAnswers:e.answers.length,questionNumber:this.round.currentQuestion+1}),await G(2),this.started&&(this.broadcastStatus(c.SHOW_QUESTION,{question:e.question,image:e.image,cooldown:e.cooldown}),await G(e.cooldown),this.started&&(this.round.startTime=Date.now(),this.broadcastStatus(c.SELECT_ANSWER,{question:e.question,answers:e.answers,image:e.image,time:e.time,totalPlayer:this.players.length}),await this.startCooldown(e.time),this.started&&this.showResults(e))))}showResults(e){let t=this.leaderboard.length===0?this.players.map(i=>({...i})):this.leaderboard.map(i=>({...i})),r=this.round.playersAnswers.reduce((i,{answerId:n})=>(i[n]=(i[n]||0)+1,i),{}),a=this.players.map(i=>{let n=this.round.playersAnswers.find(M=>M.playerId===i.id),m=n?n.answerId===e.solution:!1,q=n&&m?Math.round(n.points):0;return i.points+=q,{...i,lastCorrect:m,lastPoints:q}}).sort((i,n)=>n.points-i.points);this.players=a,a.forEach((i,n)=>{let m=n+1,q=a[n-1];this.sendStatus(i.id,c.SHOW_RESULT,{correct:i.lastCorrect,message:i.lastCorrect?"Nice!":"Too bad",points:i.lastPoints,myPoints:i.points,rank:m,aheadOfMe:q?q.username:null})}),this.sendStatus(this.manager.id,c.SHOW_RESPONSES,{question:e.question,responses:r,correct:e.solution,answers:e.answers,image:e.image}),this.leaderboard=a,this.tempOldLeaderboard=t,this.round.playersAnswers=[]}selectAnswer(e,t){let r=this.players.find(i=>i.id===e.id),a=this.quizz.questions[this.round.currentQuestion];r&&(this.round.playersAnswers.find(i=>i.playerId===e.id)||(this.round.playersAnswers.push({playerId:r.id,answerId:t,points:U(this.round.startTime,a.time)}),this.sendStatus(e.id,c.WAIT,{text:"Waiting for the players to answer"}),e.to(this.gameId).emit("game:playerAnswer",this.round.playersAnswers.length),this.io.to(this.gameId).emit("game:totalPlayers",this.players.length),this.round.playersAnswers.length===this.players.length&&this.abortCooldown()))}nextRound(e){this.started&&e.id===this.manager.id&&this.quizz.questions[this.round.currentQuestion+1]&&(this.round.currentQuestion+=1,this.newRound())}abortRound(e){this.started&&e.id===this.manager.id&&this.abortCooldown()}showLeaderboard(){if(this.round.currentQuestion+1===this.quizz.questions.length){this.started=!1,this.broadcastStatus(c.FINISHED,{subject:this.quizz.subject,top:this.leaderboard.slice(0,3)}),J.markGameAsEmpty(this),console.log(`Game ${this.gameId} finished and marked for cleanup`);return}let t=this.tempOldLeaderboard?this.tempOldLeaderboard:this.leaderboard;this.sendStatus(this.manager.id,c.SHOW_LEADERBOARD,{oldLeaderboard:t.slice(0,5),leaderboard:this.leaderboard.slice(0,5)}),this.tempOldLeaderboard=null}},Y=j;import Q from"express";import{createServer as ae}from"http";import{Server as ie}from"socket.io";var I=Q(),K=ae(I),p=new ie(K,{cors:{origin:v.WEB_ORIGIN||"*",methods:["GET","POST"],credentials:!0}});I.use(Q.json());I.use(Q.urlencoded({extended:!0}));I.use((s,e,t)=>{let r=s.headers.origin;if((r===v.WEB_ORIGIN||!v.WEB_ORIGIN)&&e.setHeader("Access-Control-Allow-Origin",r||"*"),e.setHeader("Access-Control-Allow-Methods","GET, POST, PUT, DELETE, OPTIONS"),e.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization"),e.setHeader("Access-Control-Allow-Credentials","true"),s.method==="OPTIONS")return e.sendStatus(200);t()});I.get("/",(s,e)=>{e.json({status:"ok",service:"Cahoot Socket Server",version:"1.0.0",framework:"Express + Socket.IO",uptime:process.uptime()})});I.get("/health",(s,e)=>{let t=z.getInstance();e.json({status:"healthy",connections:p.engine.clientsCount,games:t.getAllGames().length,uptime:process.uptime()})});I.use("/api/quizz",H);I.use((s,e,t,r)=>{console.error("Express error:",s),t.status(500).json({error:"Internal server error",message:"Something went wrong"})});b.init();var S=z.getInstance(),Z=process.env.PORT??v.PORT??3001;console.log(`Express + Socket.IO server running on port ${Z}`);K.listen(Number(Z));p.on("connection",s=>{console.log(`A user connected: socketId: ${s.id}, clientId: ${s.handshake.auth.clientId}`),s.on("player:reconnect",({gameId:e})=>{let t=S.getPlayerGame(e,s.handshake.auth.clientId);if(t){t.reconnect(s);return}s.emit("game:reset","Game not found")}),s.on("manager:reconnect",({gameId:e})=>{let t=S.getManagerGame(e,s.handshake.auth.clientId);if(t){t.reconnect(s);return}s.emit("game:reset","Game expired")}),s.on("manager:auth",e=>{try{let t=b.game();if(e!==t.managerPassword){s.emit("manager:errorMessage","Invalid password");return}s.emit("manager:quizzList",b.quizz())}catch(t){console.error("Failed to read game config:",t),s.emit("manager:errorMessage","Failed to read game config")}}),s.on("game:create",e=>{let r=b.quizz().find(i=>i.id===e);if(!r){s.emit("game:errorMessage","Quizz not found");return}let a=new Y(p,s,r);S.addGame(a)}),s.on("player:join",e=>{let t=F.safeParse(e);if(t.error){s.emit("game:errorMessage",t.error.issues[0].message);return}let r=S.getGameByInviteCode(e);if(!r){s.emit("game:errorMessage","Game not found");return}s.emit("game:successRoom",r.gameId)}),s.on("player:login",({gameId:e,data:t})=>y(e,s,r=>r.join(s,t.username))),s.on("manager:kickPlayer",({gameId:e,playerId:t})=>y(e,s,r=>r.kickPlayer(s,t))),s.on("manager:startGame",({gameId:e})=>y(e,s,t=>t.start(s))),s.on("player:selectedAnswer",({gameId:e,data:t})=>y(e,s,r=>r.selectAnswer(s,t.answerKey))),s.on("manager:abortQuiz",({gameId:e})=>y(e,s,t=>t.abortRound(s))),s.on("manager:nextQuestion",({gameId:e})=>y(e,s,t=>t.nextRound(s))),s.on("manager:showLeaderboard",({gameId:e})=>y(e,s,t=>t.showLeaderboard())),s.on("quizz:getAll",async()=>{try{let e=await o.getAll();s.emit("quizz:list",e)}catch(e){console.error("Failed to get quizzes:",e),s.emit("quizz:error","Failed to fetch quizzes")}}),s.on("quizz:getById",async e=>{let t=f.safeParse(e);if(t.error){s.emit("quizz:error",t.error.issues[0].message);return}try{let r=await o.getById(e);if(!r){s.emit("quizz:error","Quiz not found");return}s.emit("quizz:single",r)}catch(r){console.error(`Failed to get quiz ${e}:`,r),s.emit("quizz:error","Failed to fetch quiz")}}),s.on("quizz:create",async e=>{let t=T.safeParse(e);if(t.error){s.emit("quizz:error",t.error.issues[0].message);return}try{let{id:r,data:a}=t.data,i=await o.create(r,a);if(!i.success){s.emit("quizz:error",i.error||"Failed to create quiz");return}let n=await o.getById(r);if(!n){s.emit("quizz:error","Failed to retrieve created quiz");return}s.emit("quizz:created",n),p.emit("quizz:updated")}catch(r){console.error("Failed to create quiz:",r),s.emit("quizz:error","Failed to create quiz")}}),s.on("quizz:update",async e=>{let t=P.safeParse(e);if(t.error){s.emit("quizz:error",t.error.issues[0].message);return}try{let{id:r,data:a}=t.data,i=await o.update(r,a);if(!i.success){s.emit("quizz:error",i.error||"Failed to update quiz");return}let n=await o.getById(r);n&&s.emit("quizz:updated",n),p.emit("quizz:updated")}catch(r){console.error("Failed to update quiz:",r),s.emit("quizz:error","Failed to update quiz")}}),s.on("quizz:delete",async e=>{let t=R.safeParse(e);if(t.error){s.emit("quizz:error",t.error.issues[0].message);return}try{let{id:r}=t.data,a=await o.delete(r);if(!a.success){s.emit("quizz:error",a.error||"Failed to delete quiz");return}s.emit("quizz:deleted",{id:r}),p.emit("quizz:updated")}catch(r){console.error("Failed to delete quiz:",r),s.emit("quizz:error","Failed to delete quiz")}}),s.on("disconnect",()=>{console.log(`A user disconnected : ${s.id}`);let e=S.getGameByManagerSocketId(s.id);if(e&&(e.manager.connected=!1,S.markGameAsEmpty(e),!e.started)){console.log("Reset game (manager disconnected)"),e.abortCooldown(),p.to(e.gameId).emit("game:reset","Manager disconnected"),S.removeGame(e.gameId);return}let t=S.getGameByPlayerSocketId(s.id);if(!t)return;let r=t.players.find(a=>a.id===s.id);if(r){if(!t.started){t.players=t.players.filter(a=>a.id!==s.id),p.to(t.manager.id).emit("manager:removePlayer",r.id),p.to(t.gameId).emit("game:totalPlayers",t.players.length),console.log(`Removed player ${r.username} from game ${t.gameId}`);return}r.connected=!1,p.to(t.gameId).emit("game:totalPlayers",t.players.length)}})});process.on("SIGINT",()=>{z.getInstance().cleanup(),process.exit(0)});process.on("SIGTERM",()=>{z.getInstance().cleanup(),process.exit(0)});
//# sourceMappingURL=index.js.map
